# Prepaid Electricity Tracker Package v2
# For Home Assistant - Tracks prepaid electricity balance with real-time updates
# Supports City Power Johannesburg tiered tariffs
# Includes Sonoff ZJSB9-80 power meter integration
# Author: Created for Wynand's Deye inverter setup

# =============================================================================
# SENSOR INTEGRATIONS - Convert Sonoff Power (W) to Energy (kWh)
# =============================================================================

sensor:
  # Riemann sum integration - converts Sonoff power (W) to energy (kWh)
  - platform: integration
    source: sensor.sonoff_1000e104f7_power
    name: sonoff_grid_energy_total
    unique_id: sonoff_grid_energy_total
    unit_prefix: k
    unit_time: h
    method: left

# =============================================================================
# UTILITY METERS - Daily/Monthly tracking for Sonoff
# =============================================================================

utility_meter:
  sonoff_grid_energy_daily:
    source: sensor.sonoff_grid_energy_total
    name: Sonoff Grid Energy Daily
    cycle: daily
    
  sonoff_grid_energy_monthly:
    source: sensor.sonoff_grid_energy_total
    name: Sonoff Grid Energy Monthly
    cycle: monthly

# =============================================================================
# INPUT HELPERS - User configurable values
# =============================================================================

input_number:
  # Current prepaid balance (updated automatically and via top-up)
  prepaid_electricity_balance:
    name: Prepaid Electricity Balance
    min: 0
    max: 50000
    step: 0.01
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:lightning-bolt

  # Units to add when topping up
  prepaid_electricity_topup_amount:
    name: Top-up Amount
    min: 0
    max: 5000
    step: 0.1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:plus-circle

  # Cumulative usage tracker (persists across restarts and days)
  prepaid_electricity_cumulative_usage:
    name: Cumulative Grid Usage
    min: 0
    max: 1000000
    step: 0.001
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:counter

  # Reference point at last top-up (cumulative value at that moment)
  prepaid_electricity_topup_reference:
    name: Usage Reference at Top-up
    min: 0
    max: 1000000
    step: 0.001
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:bookmark

  # Low balance alert threshold
  prepaid_electricity_low_threshold:
    name: Low Balance Alert Threshold
    min: 0
    max: 500
    step: 1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:alert

  # Monthly usage tracker (resets on 1st of month)
  prepaid_electricity_monthly_usage:
    name: Monthly Grid Usage
    min: 0
    max: 10000
    step: 0.001
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:calendar-month

  # Store yesterday's daily usage for averaging
  prepaid_electricity_yesterday_usage:
    name: Yesterday Usage
    min: 0
    max: 1000
    step: 0.001
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:history

  # Rolling 7-day usage for better averaging
  prepaid_electricity_7day_usage:
    name: Last 7 Days Usage
    min: 0
    max: 10000
    step: 0.001
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:calendar-week

  # City Power Tariff rates (VAT inclusive)
  prepaid_tariff_block1:
    name: Tariff Block 1 (0-600 kWh)
    min: 0
    max: 10
    step: 0.0001
    unit_of_measurement: "R/kWh"
    mode: box
    icon: mdi:currency-zar
    initial: 3.9094

  prepaid_tariff_block2:
    name: Tariff Block 2 (>600 kWh)
    min: 0
    max: 10
    step: 0.0001
    unit_of_measurement: "R/kWh"
    mode: box
    icon: mdi:currency-zar
    initial: 4.6475

  # Manual sync - enter actual meter reading
  prepaid_electricity_sync_value:
    name: Actual Meter Balance
    min: 0
    max: 50000
    step: 0.1
    unit_of_measurement: "kWh"
    mode: box
    icon: mdi:sync

input_select:
  # Configurable source sensor - NOW INCLUDES SONOFF
  prepaid_electricity_source:
    name: Grid Import Source Sensor
    options:
      - sensor.sonoff_grid_energy_daily
      - sensor.deyeinvertercombined_summary_day_grid_import_buy
      - sensor.deyeinvertermaster_summary_day_grid_import_buy
      - sensor.deyeinverterslave_summary_day_grid_import_buy
    initial: sensor.sonoff_grid_energy_daily
    icon: mdi:flash

input_datetime:
  # Timestamp of last top-up
  prepaid_electricity_last_topup:
    name: Last Top-up Time
    has_date: true
    has_time: true
    icon: mdi:clock

input_button:
  # Top-up button
  prepaid_electricity_topup_button:
    name: Add Units to Balance
    icon: mdi:plus-circle-outline

  # Sync balance button
  prepaid_electricity_sync_button:
    name: Sync Balance to Meter
    icon: mdi:sync

# =============================================================================
# TEMPLATE SENSORS - Calculated values
# =============================================================================

template:
  - sensor:
      # Current balance (real-time)
      - name: "Prepaid Electricity Current Balance"
        unique_id: prepaid_electricity_current_balance
        unit_of_measurement: "kWh"
        state_class: measurement
        icon: mdi:lightning-bolt-circle
        state: >-
          {% set balance = states('input_number.prepaid_electricity_balance') | float(0) %}
          {% set cumulative = states('input_number.prepaid_electricity_cumulative_usage') | float(0) %}
          {% set reference = states('input_number.prepaid_electricity_topup_reference') | float(0) %}
          {% set source = states(states('input_select.prepaid_electricity_source')) | float(0) %}
          {% set usage_since_topup = (cumulative - reference) + source %}
          {% set current = balance - usage_since_topup %}
          {{ [current, 0] | max | round(2) }}

      # Usage since last top-up
      - name: "Prepaid Electricity Usage Since Topup"
        unique_id: prepaid_electricity_usage_since_topup
        unit_of_measurement: "kWh"
        state_class: total_increasing
        icon: mdi:transmission-tower-import
        state: >-
          {% set cumulative = states('input_number.prepaid_electricity_cumulative_usage') | float(0) %}
          {% set reference = states('input_number.prepaid_electricity_topup_reference') | float(0) %}
          {% set source = states(states('input_select.prepaid_electricity_source')) | float(0) %}
          {% set usage = (cumulative - reference) + source %}
          {{ [usage, 0] | max | round(3) }}

      # Today's usage (from source sensor directly)
      - name: "Prepaid Electricity Today Usage"
        unique_id: prepaid_electricity_today_usage
        unit_of_measurement: "kWh"
        state_class: total_increasing
        icon: mdi:calendar-today
        state: >-
          {{ states(states('input_select.prepaid_electricity_source')) | float(0) | round(3) }}

      # Average daily usage (based on 7-day rolling average)
      - name: "Prepaid Electricity Average Daily Usage"
        unique_id: prepaid_electricity_avg_daily
        unit_of_measurement: "kWh"
        icon: mdi:chart-line
        state: >-
          {% set seven_day = states('input_number.prepaid_electricity_7day_usage') | float(0) %}
          {% if seven_day > 0 %}
            {{ (seven_day / 7) | round(2) }}
          {% else %}
            {% set yesterday = states('input_number.prepaid_electricity_yesterday_usage') | float(0) %}
            {{ yesterday | round(2) if yesterday > 0 else 'unknown' }}
          {% endif %}

      # Estimated days remaining
      - name: "Prepaid Electricity Days Remaining"
        unique_id: prepaid_electricity_days_remaining
        unit_of_measurement: "days"
        icon: mdi:calendar-clock
        state: >-
          {% set balance = states('sensor.prepaid_electricity_current_balance') | float(0) %}
          {% set avg_daily = states('sensor.prepaid_electricity_average_daily_usage') %}
          {% if avg_daily not in ['unknown', 'unavailable', '0', '0.0'] and avg_daily | float(0) > 0 %}
            {{ (balance / (avg_daily | float)) | round(1) }}
          {% else %}
            unknown
          {% endif %}

      # Estimated empty date
      - name: "Prepaid Electricity Empty Date"
        unique_id: prepaid_electricity_empty_date
        icon: mdi:calendar-alert
        state: >-
          {% set days = states('sensor.prepaid_electricity_days_remaining') %}
          {% if days not in ['unknown', 'unavailable'] and days | float(0) > 0 %}
            {{ (now() + timedelta(days=days | float)) | as_timestamp | timestamp_custom('%a %d %b %Y') }}
          {% else %}
            unknown
          {% endif %}

      # Monthly usage
      - name: "Prepaid Electricity Monthly Usage"
        unique_id: prepaid_electricity_monthly_usage_sensor
        unit_of_measurement: "kWh"
        state_class: total_increasing
        icon: mdi:calendar-month
        state: >-
          {% set monthly = states('input_number.prepaid_electricity_monthly_usage') | float(0) %}
          {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
          {{ (monthly + today) | round(2) }}

      # Current tariff block
      - name: "Prepaid Electricity Current Tariff Block"
        unique_id: prepaid_electricity_tariff_block
        icon: mdi:tag
        state: >-
          {% set monthly = states('sensor.prepaid_electricity_monthly_usage') | float(0) %}
          {% if monthly <= 600 %}
            Block 1
          {% else %}
            Block 2
          {% endif %}

      # Current tariff rate
      - name: "Prepaid Electricity Current Rate"
        unique_id: prepaid_electricity_current_rate
        unit_of_measurement: "R/kWh"
        icon: mdi:currency-zar
        state: >-
          {% set monthly = states('sensor.prepaid_electricity_monthly_usage') | float(0) %}
          {% set block1 = states('input_number.prepaid_tariff_block1') | float(3.9094) %}
          {% set block2 = states('input_number.prepaid_tariff_block2') | float(4.6475) %}
          {% if monthly <= 600 %}
            {{ block1 }}
          {% else %}
            {{ block2 }}
          {% endif %}

      # Estimated Rand value of remaining balance
      - name: "Prepaid Electricity Balance Value"
        unique_id: prepaid_electricity_balance_value
        unit_of_measurement: "R"
        icon: mdi:cash
        state: >-
          {% set balance = states('sensor.prepaid_electricity_current_balance') | float(0) %}
          {% set monthly = states('sensor.prepaid_electricity_monthly_usage') | float(0) %}
          {% set block1_rate = states('input_number.prepaid_tariff_block1') | float(3.9094) %}
          {% set block2_rate = states('input_number.prepaid_tariff_block2') | float(4.6475) %}
          {% set block1_remaining = [600 - monthly, 0] | max %}
          {% if balance <= block1_remaining %}
            {{ (balance * block1_rate) | round(2) }}
          {% else %}
            {% set block1_value = block1_remaining * block1_rate %}
            {% set block2_units = balance - block1_remaining %}
            {% set block2_value = block2_units * block2_rate %}
            {{ (block1_value + block2_value) | round(2) }}
          {% endif %}

      # Monthly cost so far
      - name: "Prepaid Electricity Monthly Cost"
        unique_id: prepaid_electricity_monthly_cost
        unit_of_measurement: "R"
        icon: mdi:cash-multiple
        state: >-
          {% set monthly = states('sensor.prepaid_electricity_monthly_usage') | float(0) %}
          {% set block1_rate = states('input_number.prepaid_tariff_block1') | float(3.9094) %}
          {% set block2_rate = states('input_number.prepaid_tariff_block2') | float(4.6475) %}
          {% if monthly <= 600 %}
            {{ (monthly * block1_rate) | round(2) }}
          {% else %}
            {% set block1_cost = 600 * block1_rate %}
            {% set block2_cost = (monthly - 600) * block2_rate %}
            {{ (block1_cost + block2_cost) | round(2) }}
          {% endif %}

      # Low balance status (for conditional cards)
      - name: "Prepaid Electricity Low Balance"
        unique_id: prepaid_electricity_low_balance
        icon: mdi:alert-circle
        state: >-
          {% set balance = states('sensor.prepaid_electricity_current_balance') | float(0) %}
          {% set threshold = states('input_number.prepaid_electricity_low_threshold') | float(50) %}
          {{ balance < threshold }}

      # Sonoff real-time power display
      - name: "Prepaid Electricity Current Power"
        unique_id: prepaid_electricity_current_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:flash
        state: >-
          {{ states('sensor.sonoff_1000e104f7_power') | float(0) | round(0) }}

      # Sonoff voltage display
      - name: "Prepaid Electricity Voltage"
        unique_id: prepaid_electricity_voltage
        unit_of_measurement: "V"
        device_class: voltage
        state_class: measurement
        icon: mdi:sine-wave
        state: >-
          {{ states('sensor.sonoff_1000e104f7_voltage') | float(0) | round(1) }}

      # Sonoff current display
      - name: "Prepaid Electricity Current Amps"
        unique_id: prepaid_electricity_current_amps
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        icon: mdi:current-ac
        state: >-
          {{ states('sensor.sonoff_1000e104f7_current') | float(0) | round(2) }}

      # Active source indicator
      - name: "Prepaid Electricity Active Source"
        unique_id: prepaid_electricity_active_source
        icon: mdi:information
        state: >-
          {% set source = states('input_select.prepaid_electricity_source') %}
          {% if 'sonoff' in source %}
            Sonoff Meter
          {% elif 'combined' in source %}
            Deye Combined
          {% elif 'master' in source %}
            Deye Master
          {% elif 'slave' in source %}
            Deye Slave
          {% else %}
            {{ source }}
          {% endif %}

# =============================================================================
# AUTOMATIONS
# =============================================================================

automation:
  # Top-up button pressed - add units to balance
  - alias: "Prepaid Electricity: Process Top-up"
    id: prepaid_electricity_process_topup
    description: "Adds top-up units to balance and records reference point"
    trigger:
      - platform: state
        entity_id: input_button.prepaid_electricity_topup_button
    condition:
      - condition: template
        value_template: "{{ states('input_number.prepaid_electricity_topup_amount') | float(0) > 0 }}"
    action:
      # Calculate new balance
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_balance
        data:
          value: >-
            {% set current = states('sensor.prepaid_electricity_current_balance') | float(0) %}
            {% set topup = states('input_number.prepaid_electricity_topup_amount') | float(0) %}
            {{ current + topup }}
      # Set reference point to current cumulative + today's usage
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_topup_reference
        data:
          value: >-
            {% set cumulative = states('input_number.prepaid_electricity_cumulative_usage') | float(0) %}
            {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
            {{ cumulative + today }}
      # Record timestamp
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.prepaid_electricity_last_topup
        data:
          datetime: "{{ now().isoformat() }}"
      # Clear the top-up input field
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_topup_amount
        data:
          value: 0
      # Send confirmation notification
      - service: persistent_notification.create
        data:
          title: "Electricity Top-up Processed"
          message: >-
            Added {{ states('input_number.prepaid_electricity_topup_amount') }} kWh.
            New balance: {{ states('sensor.prepaid_electricity_current_balance') }} kWh
          notification_id: "prepaid_topup_confirm"

  # Sync button pressed - set balance to actual meter reading
  - alias: "Prepaid Electricity: Sync Balance"
    id: prepaid_electricity_sync_balance
    description: "Synchronizes tracker balance with actual meter reading"
    trigger:
      - platform: state
        entity_id: input_button.prepaid_electricity_sync_button
    condition:
      - condition: template
        value_template: "{{ states('input_number.prepaid_electricity_sync_value') | float(0) > 0 }}"
    action:
      # Set balance to the sync value directly
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_balance
        data:
          value: "{{ states('input_number.prepaid_electricity_sync_value') | float(0) }}"
      # Reset reference point to current cumulative + today's usage
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_topup_reference
        data:
          value: >-
            {% set cumulative = states('input_number.prepaid_electricity_cumulative_usage') | float(0) %}
            {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
            {{ cumulative + today }}
      # Clear the sync input field
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_sync_value
        data:
          value: 0
      # Send confirmation notification
      - service: persistent_notification.create
        data:
          title: "Balance Synchronized"
          message: >-
            Balance synchronized to {{ states('input_number.prepaid_electricity_sync_value') }} kWh.
            Tracker is now in sync with your meter.
          notification_id: "prepaid_sync_confirm"

  # Midnight - capture daily usage and update cumulative tracker
  - alias: "Prepaid Electricity: Daily Rollover"
    id: prepaid_electricity_daily_rollover
    description: "At midnight, add today's usage to cumulative and reset trackers"
    trigger:
      - platform: time
        at: "23:59:55"
    action:
      # Store today's usage for yesterday reference
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_yesterday_usage
        data:
          value: "{{ states(states('input_select.prepaid_electricity_source')) | float(0) }}"
      # Add to cumulative usage
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_cumulative_usage
        data:
          value: >-
            {% set cumulative = states('input_number.prepaid_electricity_cumulative_usage') | float(0) %}
            {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
            {{ cumulative + today }}
      # Add to monthly usage
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_monthly_usage
        data:
          value: >-
            {% set monthly = states('input_number.prepaid_electricity_monthly_usage') | float(0) %}
            {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
            {{ monthly + today }}
      # Update 7-day rolling usage
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_7day_usage
        data:
          value: >-
            {% set current_7day = states('input_number.prepaid_electricity_7day_usage') | float(0) %}
            {% set today = states(states('input_select.prepaid_electricity_source')) | float(0) %}
            {% set yesterday = states('input_number.prepaid_electricity_yesterday_usage') | float(0) %}
            {# Simple approximation: add today, subtract 1/7th to maintain rolling average #}
            {% set new_7day = current_7day + today - (current_7day / 7) %}
            {{ [new_7day, 0] | max }}
      # Update stored balance to match current calculated balance
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_balance
        data:
          value: "{{ states('sensor.prepaid_electricity_current_balance') | float(0) }}"
      # Reset reference to new cumulative
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_topup_reference
        data:
          value: "{{ states('input_number.prepaid_electricity_cumulative_usage') | float(0) }}"

  # Monthly reset (1st of month at midnight)
  - alias: "Prepaid Electricity: Monthly Reset"
    id: prepaid_electricity_monthly_reset
    description: "Reset monthly usage counter on 1st of each month"
    trigger:
      - platform: time
        at: "00:00:05"
    condition:
      - condition: template
        value_template: "{{ now().day == 1 }}"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_monthly_usage
        data:
          value: 0

  # Low balance alert - WhatsApp notification
  - alias: "Prepaid Electricity: Low Balance Alert"
    id: prepaid_electricity_low_balance_alert
    description: "Send WhatsApp alert when balance drops below threshold"
    trigger:
      - platform: template
        value_template: >-
          {% set balance = states('sensor.prepaid_electricity_current_balance') | float(999) %}
          {% set threshold = states('input_number.prepaid_electricity_low_threshold') | float(50) %}
          {{ balance < threshold and balance > 0 }}
    condition:
      # Only fire once per day
      - condition: template
        value_template: >-
          {% set last = state_attr('automation.prepaid_electricity_low_balance_alert', 'last_triggered') %}
          {{ last is none or (now() - last).total_seconds() > 86400 }}
    action:
      - service: notify.whatsapp
        data:
          message: >-
            ⚡ LOW ELECTRICITY BALANCE ⚡
            
            Balance: {{ states('sensor.prepaid_electricity_current_balance') }} kWh
            Value: R{{ states('sensor.prepaid_electricity_balance_value') }}
            Est. days left: {{ states('sensor.prepaid_electricity_days_remaining') }}
            
            Please top-up soon!
      - service: persistent_notification.create
        data:
          title: "⚡ Low Electricity Balance"
          message: >-
            Your prepaid balance is {{ states('sensor.prepaid_electricity_current_balance') }} kWh 
            (R{{ states('sensor.prepaid_electricity_balance_value') }}).
            Estimated {{ states('sensor.prepaid_electricity_days_remaining') }} days remaining.
          notification_id: "prepaid_low_balance"

  # Clear low balance notification when topped up
  - alias: "Prepaid Electricity: Clear Low Balance Alert"
    id: prepaid_electricity_clear_low_alert
    description: "Clear persistent notification when balance is restored"
    trigger:
      - platform: template
        value_template: >-
          {% set balance = states('sensor.prepaid_electricity_current_balance') | float(0) %}
          {% set threshold = states('input_number.prepaid_electricity_low_threshold') | float(50) %}
          {{ balance >= threshold }}
    action:
      - service: persistent_notification.dismiss
        data:
          notification_id: "prepaid_low_balance"

  # Initialize on startup if needed
  - alias: "Prepaid Electricity: Initialize on Startup"
    id: prepaid_electricity_startup_init
    description: "Set initial values if this is a fresh installation"
    trigger:
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: "{{ states('input_number.prepaid_electricity_low_threshold') | float(0) == 0 }}"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.prepaid_electricity_low_threshold
        data:
          value: 50
